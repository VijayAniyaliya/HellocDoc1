@model HellocDoc1.Services.Models.PatientServiceModel

@{
    ViewData["Title"] = "Patient_Document";
    Layout = "~/Views/Shared/_PatientDashboardLayout.cshtml";
}

<div class="container">
    <div class="d-flex justify-content-between pt-3">
        <h4>Documents</h4>
        <a asp-area="" asp-controller="Patient" asp-action="Patient_Dashboard" class="btn back-btn border border-info text-info p-2">
            &lt; Back
        </a>
    </div>
    <div class="px-3 pt-4 shadow Document-content mt-3" style="">
        <div class="h6 text-secondary">Patient Name</div>
        <div class="h5 text-info d-inline-block">@Model.requestClient.FirstName @Model.requestClient.LastName</div>
        <div class="h5 d-inline-block">
            @if (Model.request.ConfirmationNumber != null)
            {
                @("(" + Model.request.ConfirmationNumber + ")")
                ;
            }
        </div>
        <div class="h6 text-secondary mt-3">Check here for any files that you or the doctors of your subsequents have attached for you to review</div>
        <form asp-action="UploadDocument" asp-route-request_id="@Model.request.RequestId" asp-controller="Patient" method="post" enctype="multipart/form-data">
            <div class="input-group mb-3 mt-4 border rounded-3 d-flex justify-content-between flex-row">
                <input type="file" class="form-control" asp-for="Doc" id="inputGroupFile02" hidden multiple>
                <label class="my-auto ms-2 col-md-10 col-sm-9 col-8" for="inputGroupFile02" id="fileselect">Select file</label>
                <button type="submit" class=" btn bg-info text-white d-flex flex-row mb-0 p-2 border rounded-3 upload" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#ffffff"
                         class="bi bi-cloud-upload my-auto mx-1" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                              d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383" />
                        <path fill-rule="evenodd"
                              d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z" />
                    </svg>
                    <br />
                    <span>Upload</span>
                </button>
            </div>
        </form>
        <div class="d-flex justify-content-between pt-3">
            <h5>Documents</h5>
            <a asp-controller="Patient" onclick="DownloadAll" asp-action="DownloadAll" asp-route-request_id="@Model.request.RequestId" class="btn downloadall text-info border-1 border-info">
                Download All
            </a>
            <a onclick="downloadSelectedFiles()" id="download" class="btn text-info d-md-block d-none border-1 border-info">
                Download
            </a>         
            <a onclick="downloadSelectedFile()" id="download" class="btn text-info d-md-none d-block border-1 border-info">
                Download
            </a>
        </div>
        <div class="table-responsive mt-2">
            <table class="table d-md-table d-none">
                <thead>
                    <tr>
                        <th class="text-center"><input type="checkbox" class="form-check-input checks" id="All" style="left: 18px; position:relative" /></th>
                        <th scope="col"></th>
                        <th scope="col">Uploader</th>
                        <th scope="col">Upload Date</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody class="dash">
                    @foreach (var item in Model.requestWiseFile)
                    {
                        <tr>
                            <td><input type="checkbox" data-id="@item.RequestWiseFileId" class="ChildCheck form-check-input checks text-center" name="checkdoc" style="left: 25px; position:relative;" /></td>
                            <td><i class="bi bi-file-earmark-medical-fill mr-1 h5 fs-3" style="color:#f50707"></i>@item.FileName</td>
                            <td>
                                @item.Request.FirstName @item.Request.LastName
                            </td>
                            <td>@item.CreatedDate.ToString("MMM dd yyyy")</td>
                            <td>
                                <a href="~/uploads/@item.FileName" class="border border-info rounded-3 py-1 px-2" download="">
                                    <i class="bi bi-cloud-arrow-down text-info"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="d-md-none d-block">
                @foreach (var item in Model.requestWiseFile)
                {   
                    <hr />
                    <div>
                        <input type="checkbox" data-ids="@item.RequestWiseFileId" class="ChildCheck form-check-input checks text-center mr-2" name="checkdocs" style="left: 21px; position:relative;" />
                        <span class="" style="left: 21px; position:relative;"><i class="bi bi-file-earmark-medical-fill mr-1 h5 fs-3" style="color:#f50707"></i>@item.FileName</span>
                    </div>
                    <div class="my-3">
                        @item.Request.FirstName @item.Request.LastName
                    </div>
                    <div class="my-3">
                        @item.CreatedDate.ToString("MMM dd yyyy")
                    </div>
                    <div class="">
                        <a href="~/uploads/@item.FileName" class="btn border-2 border-info rounded-3 pb-2 pt-1 px-2 mr-2" download="">
                            <i class="bi bi-cloud-arrow-down text-info h4 fw-bolder"></i>
                        </a>
                    </div>
                    <hr />
                }
            </div>
        </div>
        <br />
        <br />
    </div>
</div>
<br />
<br />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    // function DownloadAll(request_id) {
    //     $.ajax({
    //         url: "/Admin/Delete",
    //         data: { request_id: request_id },
    //         type: "POST",
    //         dataType: "html",
    //         success: function (data) {
    //             window.location.reload();
    //             console.log("success")
    //         },
    //         error: function () {
    //             alert("No Projects Found");
    //         }
    //     });
    // };
    function downloadSelectedFile() {
        var selectedFiles = document.querySelectorAll('input[name="checkdocs"]:checked');
        var fileUrls = [];

        if (selectedFiles.length === 0) {
            toastr.error('Please select files to download');
            return;
        }
        selectedFiles.forEach(function (checkbox) {
            var row = checkbox.closest('tr');
            var fileUrl = row.querySelector('a').getAttribute('href');
            fileUrls.push(fileUrl);
        });

        fileUrls.forEach(function (url) {
            var link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
    $(document).ready(function () {
        $("#download").css('display', 'block');
        $(".downloadall").css('display', 'none');
        $("#All").change(function () {
            if ($(this).is(":checked")) {
                $("#download").css('display', 'none');
                $(".downloadall").css('display', 'block');
            } else {    
                $("#download").css('display', 'block');
                $(".downloadall").css('display', 'none');
            }
        });
        $('#All').click(function () {
            $('.ChildCheck').prop('checked', this.checked);
        });
        $('.ChildCheck').click(function () {
            $('#All').prop('checked', $('.ChildCheck:checked').length === $('.ChildCheck').length);
        });
    });
    function downloadSelectedFiles() {
        var selectedFiles = document.querySelectorAll('input[name="checkdoc"]:checked');
        var fileUrls = [];

        if (selectedFiles.length === 0) {
            toastr.error('Please select files to download');
            return;
        }
        selectedFiles.forEach(function (checkbox) {
            var row = checkbox.closest('tr');
            var fileUrl = row.querySelector('a').getAttribute('href');
            fileUrls.push(fileUrl);
        });

        fileUrls.forEach(function (url) {
            var link = document.createElement('a');
            link.href = url;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
</script>